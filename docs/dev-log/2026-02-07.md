🇯🇵 日本語（メイン記録用）
📅 2026-02-07
🔐 認証リダイレクト構造の安定化 & 詳細ページ復帰問題の解決
✅ 本日の目的

ログイン後に常にトップページへ戻ってしまう問題を解決し、
ログアウト → 再ログイン後も元のページに復帰できる構造へ改善。

✅ 実施内容
1. ログインフローの単一化

startGoogleLogin(next) に統一

直接 signInWithOAuth() を呼び出していた箇所を削除

redirect先を /auth/callback に完全固定

2. nextパス管理の統一

buildNext(pathname, search) 実装

saveNext() / loadNext() / clearNext() 整理

localStorageベースで復帰URLを保存

3. RequireAuthOutlet 改善

未ログイン時：

現在のパスを保存

/auth?next=現在パス にリダイレクト

保護ルートの挙動を統一。

4. AuthCallback ロジック整理

exchangeCodeForSession() 確定

next優先順位：

localStorage > query next > "/"


復帰後に clearNext() 実行

5. AuthButton 条件修正

ログイン判定の分岐ミス修正

ログイン時のみ：

アバター表示

ニックネーム表示

Logoutボタン表示

✅ 結果

詳細ページ → ログアウト → 再ログイン → 同ページ復帰 成功

認証フロー完全安定

コンポーネント間のリダイレクト不一致解消

将来拡張時のバグリスク低減

🔧 現在の認証構造
authRedirect.ts
authActions.ts
RequireAuthOutlet
AuthCallback
AuthButton

🇺🇸 English
📅 2026-02-07
🔐 Authentication Redirect Stabilization & Detail Page Persistence Fix
Objective

Fix the issue where users were redirected to the homepage after login,
and ensure users remain on the same page after logout → login.

What Was Done
1. Unified Login Entry Point

Standardized login via startGoogleLogin(next)

Removed scattered signInWithOAuth() calls

Redirect target fixed to /auth/callback

2. Centralized "next" Path Handling

Implemented buildNext(pathname, search)

Organized saveNext(), loadNext(), clearNext()

Used localStorage to persist return path

3. Improved RequireAuthOutlet

Save current path when unauthenticated

Redirect to /auth?next=currentPath

4. Refactored AuthCallback Logic

Priority order:

localStorage > query next > "/"


Clear stored path after navigation.

5. Fixed AuthButton Condition Logic

Corrected login state branching

Show avatar & nickname only when authenticated

Result

Detail page persistence works after re-login

Authentication flow fully stabilized

Eliminated inconsistent redirect behaviors

Architecture ready for scaling

🇰🇷 한국어
📅 2026-02-07
🔐 로그인 리다이렉트 구조 안정화 & 상세페이지 유지 문제 해결
🎯 목적

로그인 후 홈으로 튀는 문제 해결
로그아웃 → 재로그인 시 기존 페이지 유지

🔧 작업 내용
1. 로그인 단일 진입점 확립

startGoogleLogin(next) 로 통일

개별 OAuth 호출 제거

redirect는 /auth/callback 고정

2. next 경로 관리 체계화

buildNext() 구현

localStorage 기반 복귀 경로 관리

3. RequireAuthOutlet 정리

비로그인 시 현재 경로 저장

/auth?next=현재경로 이동

4. AuthCallback 정리

우선순위:

localStorage > query next > "/"


복귀 후 clear

5. AuthButton 분기 수정

로그인 상태일 때만 프로필/닉네임 표시

✅ 결과

상세페이지 유지 정상 동작

인증 흐름 완전 통일

구조 안정화 완료

확장 가능한 상태 확보